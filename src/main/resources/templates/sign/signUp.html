<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}"
>
<div layout:fragment="main">
<head>
<style>
  .form-group {
    position: relative;
    margin-bottom: 15px;
  }
  .hide {
    display: none;
  }
</style>
</head>
  <div class="container">
    <form action="/sign/sign-up" method="post" id="signupForm">
      <div class="form-group">
        <label for="memberId">아이디</label>
        <input type="text" id="memberId" name="memberId" placeholder="아이디를 입력하세요" required>
        <button type="button" id="checkIdButton">중복 확인</button>
        <!-- 아이디 검증 메시지 -->
        <div class="success-message hide">사용할 수 있는 아이디입니다</div>
        <div class="failure-message hide">아이디는 4~12글자이어야 합니다</div>
        <div class="failure-message2 hide">영어 또는 숫자만 가능합니다</div>
        <div id="idMessage" class="hide"></div>
      </div>

      <div class="form-group">
        <label for="password">비밀번호</label>
        <input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요" required>
      </div>
      <!-- 비밀번호 검증 메시지 -->
      <div class="strongPassword-message hide">8-20글자, 영문, 숫자, 특수문자를 사용하세요</div>
      <div class="longPassword-message hide">비밀번호는 20자를 넘을 수 없습니다</div>

      <div class="form-group">
        <label for="password-retype">비밀번호 확인</label>
        <input type="password" id="password-retype" placeholder="비밀번호 확인" required />
      </div>
      <!-- 비밀번호 확인 실패 메시지 -->
      <div class="mismatch-message hide">비밀번호가 일치하지 않습니다</div>

      <div class="form-group">
        <label for="name">이름</label>
        <input type="text" id="name" name="name" placeholder="이름을 입력하세요" required>
      </div>
      <!-- 이름 검증 메시지 -->
      <div class="success-message-name hide">사용할 수 있는 이름입니다</div>
      <div class="failure-message-name hide">이름은 2~10글자이어야 합니다</div>
      <div class="failure-message2-name hide">한글만 입력해주세요.</div>

      <div class="form-group">
        <label for="email">이메일</label>
        <input type="email" id="email" name="email" placeholder="이메일을 입력하세요" required>
        <button type="button" id="checkEmailButton">중복 확인</button>
        <div id="emailMessage" class="hide"></div>
      </div>

      <div class="form-group">
        <label for="phone">핸드폰 번호</label>
        <input type="tel" id="phone" name="phone" placeholder="핸드폰 번호를 입력하세요" required>
      </div>

      <div class="form-group">
        <input type="hidden" id="schoolLevel" name="schoolLevel" value="M"/>
      </div>

      <div class="form-group">
        <button type="submit">회원가입</button>
      </div>
    </form>
  </div>

<script th:inline="javascript">
  let elInputMemberId = document.querySelector('#memberId');
  let elSuccessMessage = document.querySelector('.success-message');
  let elFailureMessage = document.querySelector('.failure-message');
  let elFailureMessageTwo = document.querySelector('.failure-message2');

  let elInputPassword = document.querySelector('#password');
  let elInputPasswordRetype = document.querySelector('#password-retype');
  let elMismatchMessage = document.querySelector('.mismatch-message');
  let elStrongPasswordMessage = document.querySelector('.strongPassword-message');
  let elLongPasswordMessage = document.querySelector('.longPassword-message');

  let elInputName = document.querySelector('#name');
  let elSuccessMessageName = document.querySelector('.success-message-name');
  let elFailureMessageName = document.querySelector('.failure-message-name');
  let elFailureMessageTwoName = document.querySelector('.failure-message2-name');



  function strongPassword(str){
    return /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,20}$/.test(str);
  }

  function isMatch(password1, password2){
    return password1 === password2;
  }

  function nameLength(value){
    return value.length >= 2 && value.length <= 10;
  }

  function onlyKorean(str){
    return /^[가-힣]+$/.test(str);
  }




  // 비밀번호 유효성 검사
  elInputPassword.addEventListener('input', function () {
    const inputValue = elInputPassword.value;
    if(inputValue.length !== 0){
      if (inputValue.length > 20) {
        elStrongPasswordMessage.classList.add('hide');
        elLongPasswordMessage.classList.remove('hide');
      } else if (strongPassword(inputValue)) {
        elStrongPasswordMessage.classList.add('hide');
        elLongPasswordMessage.classList.add('hide');
      } else {
        elStrongPasswordMessage.classList.remove('hide');
        elLongPasswordMessage.classList.add('hide');
      }
    }
    else {
      elStrongPasswordMessage.classList.add('hide');
      elLongPasswordMessage.classList.add('hide');
    }
  });

  // 비밀번호 확인
  elInputPasswordRetype.addEventListener('input', function(){
    const inputValue = elInputPasswordRetype.value;
    if(inputValue.length !== 0) {
      if (isMatch(elInputPassword.value, inputValue)) {
        elMismatchMessage.classList.add('hide');
      } else {
        elMismatchMessage.classList.remove('hide');
      }
    }
    else {
      elMismatchMessage.classList.add('hide');
    }
  });

  // 이름 유효성 검사
  elInputName.addEventListener('input', function (){
    const inputValue = elInputName.value;

    // 기본적으로 모든 메시지 숨기기
    elSuccessMessageName.classList.add('hide');
    elFailureMessageName.classList.add('hide');
    elFailureMessageTwoName.classList.add('hide');

    // 이름이 비어 있으면 한글만 표시 메시지를 숨김
    if(inputValue.length !== 0) {
      if (!onlyKorean(inputValue)) {
        elFailureMessageTwoName.classList.remove('hide'); // 한글만 입력 가능
      } else if (!nameLength(inputValue)) {
        elFailureMessageName.classList.remove('hide'); // 길이가 2~10자가 아니면
      } else {
        elSuccessMessageName.classList.remove('hide'); // 유효한 이름
      }
    } else {
      elFailureMessageTwoName.classList.remove('hide'); // 이름을 입력해주세요 메시지
    }
  });
</script>

  <script th:inline="javascript">
    function idLength(value){
      return value.length >= 4 && value.length <= 12;
    }

    function onlyNumberAndEnglish(str){
      return /^[A-Za-z0-9]*$/.test(str);
    }
    let idChecked = false;
    let emailChecked = false;

    document.getElementById('checkIdButton').addEventListener('click', function (){
      const memberId = document.getElementById('memberId').value;
      const elSuccessMessage = document.querySelector('.success-message');
      const elFailureMessage = document.querySelector('.failure-message');
      const elFailureMessageTwo = document.querySelector('.failure-message2');
      const idMessage = document.getElementById('idMessage');

      // 유효성 검사 메시지 숨기기
      elSuccessMessage.classList.add('hide');
      elFailureMessage.classList.add('hide');
      elFailureMessageTwo.classList.add('hide');

      if(memberId.length === 0 ){
        alert("아이디를 입력해주세요.");
        return;
      }
      fetch('/sign/check-id', {
        method: 'POST',
        headers: {
          'Content-Type' : 'application/json',
        },
        body: JSON.stringify({memberId: memberId}),
      })
              .then(response => response.json())
              .then(data => {
                const idMessage = document.getElementById('idMessage');
                if(data.isAvailable){
                  idMessage.textContent = "사용 가능한 아이디입니다.";
                  idMessage.style.color = "green";
                  idChecked = true;
                } else{
                  idMessage.textContent = "이미 사용 중인 아이디입니다.";
                  idMessage.style.color = "red";
                  idChecked = false;
                }
                idMessage.classList.remove('hide');
              })
              .catch(error => console.error('Error checking ID:', error));
    });
    // 값 변경될때마다 중복확인 다시 하기
    document.getElementById('memberId').addEventListener('input', function (){
      idChecked = false;
    });

    // 아이디 유효성 검사
    elInputMemberId.addEventListener('input', function () {
      const inputValue = elInputMemberId.value;
      const elSuccessMessage = document.querySelector('.success-message');
      const elFailureMessage = document.querySelector('.failure-message');
      const elFailureMessageTwo = document.querySelector('.failure-message2');

      // 중복 확인 메시지 숨기기
      const idMessage = document.getElementById('idMessage');
      idMessage.classList.add('hide');

      if (inputValue.length !== 0) {
        if (!onlyNumberAndEnglish(inputValue)) {
          elSuccessMessage.classList.add('hide');
          elFailureMessage.classList.add('hide');
          elFailureMessageTwo.classList.remove('hide');
        } else if (!idLength(inputValue)) {
          elSuccessMessage.classList.add('hide');
          elFailureMessage.classList.remove('hide');
          elFailureMessageTwo.classList.add('hide');
        } else {
          elSuccessMessage.classList.remove('hide');
          elFailureMessage.classList.add('hide');
          elFailureMessageTwo.classList.add('hide');
        }
      } else {
        elSuccessMessage.classList.add('hide');
        elFailureMessage.classList.add('hide');
        elFailureMessageTwo.classList.add('hide');
      }
    });


    // 이메일 중복 확인
    document.getElementById('checkEmailButton').addEventListener('click', function () {
      const email = document.getElementById('email').value;
      const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      const emailMessage = document.getElementById('emailMessage');

      if (email.length === 0) {
        alert("이메일을 입력해주세요.");
        return;
      }
      if (!emailRegex.test(email)) {
        emailMessage.textContent = "올바른 이메일 형식을 입력해주세요.";
        emailMessage.style.color = "red";
        emailMessage.classList.remove('hide');
        emailChecked = false;
        return;
      }

      fetch('/sign/check-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email }),
      })
              .then(response => response.json())
              .then(data => {
                const emailMessage = document.getElementById('emailMessage');
                if (data.isAvailable) {
                  emailMessage.textContent = "사용 가능한 이메일입니다.";
                  emailMessage.style.color = "green";
                  emailChecked = true;
                } else {
                  emailMessage.textContent = "이미 사용 중인 이메일입니다.";
                  emailMessage.style.color = "red";
                  emailChecked = false;
                }
                emailMessage.classList.remove('hide');
              })
              .catch(error => console.error('Error checking email:', error));
    });

    // 값 변경될때마다 중복확인 다시 하기
    document.getElementById('email').addEventListener('input', function (){
      emailChecked = false;
    });

    document.getElementById('email').addEventListener('input', function () {
      const emailMessage = document.getElementById('emailMessage');
      emailMessage.classList.add('hide');
    });

    document.getElementById('signupForm').addEventListener('submit', function (event){
      if(!idChecked){
        alert("아이디 중복 확인을 해주세요.");
        event.preventDefault();
      }
      if(!emailChecked){
        alert("이메일 중복 확인을 해주세요.");
        event.preventDefault();
      }
    })
  </script>
</div>
